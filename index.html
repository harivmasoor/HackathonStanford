<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Transcription and Document Upload</title>
</head>
<body>
    <h1>Real-time Transcription</h1>

    <button id="startStopBtn" onclick="toggleRecording()">Start Recording</button>

    <h2>Transcription Result:</h2>
    <pre id="transcriptionResult"></pre>

    <h1>Document Upload</h1>

    <input type="file" id="documentFile" accept=".pdf,.doc,.docx,.txt">
    <button onclick="processDocument()">Process Document</button>

    <h2>Document Processing Result:</h2>
    <pre id="documentResult"></pre>

    <script>
        let isRecording = false;
        let mediaRecorder;
        const audioChunks = [];

        // Connect to the transcription updates endpoint using Server-Sent Events
        const eventSource = new EventSource('http://localhost:5001/transcription-updates');

        eventSource.onmessage = function(event) {
            const transcription = JSON.parse(event.data);
            document.getElementById('transcriptionResult').textContent = transcription;
        };

        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        async function startRecording() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
                if (mediaRecorder.state === "inactive") {
                    const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
                    sendAudioToServer(audioBlob);
                }
            };
            mediaRecorder.start();
            isRecording = true;
            document.getElementById('startStopBtn').textContent = "Stop Recording";
        }

        function stopRecording() {
            mediaRecorder.stop();
            isRecording = false;
            document.getElementById('startStopBtn').textContent = "Start Recording";
        }

        function sendAudioToServer(audioBlob) {
            const formData = new FormData();
            formData.append('audio', audioBlob);

            fetch('http://localhost:5001/transcribe', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.headers.get('Content-Type').includes('application/json')) {
                    return response.json();
                } else {
                    return response.text().then(text => {
                        throw new Error(text);
                    });
                }
            })
            .then(data => {
                if (data.success) {
                    console.log('Transcription request sent successfully.');
                } else {
                    console.error('Error:', data.reason);
                    alert('Failed to transcribe audio. Please check the console for details.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to transcribe audio. Please check the console for details.');
            });
        }

        function processDocument() {
            const documentFileInput = document.getElementById('documentFile');
            const documentFile = documentFileInput.files[0];

            if (!documentFile) {
                alert('Please select a document first.');
                return;
            }

            const formData = new FormData();
            formData.append('document', documentFile);

            fetch('http://localhost:5001/process-document', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.headers.get('Content-Type').includes('application/json')) {
                    return response.json();
                } else {
                    return response.text().then(text => {
                        throw new Error(text);
                    });
                }
            })
            .then(data => {
                if (data.success) {
                    console.log('Document processed successfully.');
                    document.getElementById('documentResult').textContent = data.result;
                } else {
                    console.error('Error:', data.reason);
                    alert('Failed to process document. Please check the console for details.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to process document. Please check the console for details.');
            });
        }
    </script>
</body>
</html>


